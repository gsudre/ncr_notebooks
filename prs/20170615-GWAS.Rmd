---
title: "GWAS PRS"
output: html_notebook
---

Philip asked me to run PRS for all our kids using the new PGC data that was just released, and then grab the kids that were in the GWAS study to see if the new PRS does a better job correlating with the brain growth variables used.

```{r}
gwas = read.csv('/Volumes/Labs/CIDR/for_Philip/FINAL_pheno_file_nhgri_genr_combined_18Aug2016.csv')
gwas = gwas[gwas$COHORT=='nhgri_nimh',]
pgc = read.csv('~/data/baseline_prediction/stripped/PRS2017_original_clump_default.csv')
pgc_eur = read.csv('~/data/baseline_prediction/stripped/PRS2017eur_original_clump_default.csv')
```

Let's combine the GWAS data and PRS to restrict the size of our matrices:

```{r}
df = merge(gwas, pgc, by.x='PERSON', by.y = 'MRN')
# remove duplicated MRNs
df = df[!duplicated(df$PERSON),]
# just judging based on frequencies, but might be better to check the actual coding later
df_eur = merge(gwas, pgc_eur, by.x='PERSON', by.y = 'MRN')
df_eur = df_eur[!duplicated(df_eur$PERSON),]
eur_idx = df_eur$RACExx==1 & df_eur$ETHNICTYxx==1
df_eur = df_eur[eur_idx, ]
```

Now we're ready to run our LME using family ID as the random term:

```{r}
library(nlme)
dep_vars = which(grepl('^Nresid', colnames(df)))
indep_vars = which(grepl('^PROFILES', colnames(df)))
res = as.data.frame(matrix(nrow=length(indep_vars), ncol=(2*length(dep_vars))))
rownames(res) = colnames(df)[indep_vars]
i = 1
cnt = 1
while (i < 2*length(dep_vars)) {
  colnames(res)[i] = sprintf('%s_tstat', colnames(df)[dep_vars][cnt])
  colnames(res)[i+1] = sprintf('%s_pval', colnames(df)[dep_vars][cnt])
  i = i + 2
  cnt = cnt + 1
}
for (i in 1:length(indep_vars)) {
  for (j in 1:length(dep_vars)) {
    y_str = colnames(df)[dep_vars][j]
    x_str = colnames(df)[indep_vars][i]
    fm_str = sprintf('%s ~ %s', y_str, x_str)
    fit = try(lme(as.formula(fm_str), random=~1|FID, data=df, na.action = na.omit))
    res[x_str, sprintf('%s_tstat', y_str)] = summary(fit)$tTable[x_str,'t-value']
    res[x_str, sprintf('%s_pval', y_str)] = summary(fit)$tTable[x_str,'p-value']
  }
}
```

Now let's make a plot to see the evolution of p-values for each profile, one curve per brain region:

```{r}
plot_me = which(grepl('_pval$', colnames(res)))
x = 1:nrow(res)
for (i in plot_me) {
  plot(x, res[, i], lty=3, ylab=colnames(res)[i], xlab='profiles')
}
write.csv(res, file='~/tmp/gwas_all_prs.csv')
```

And do the same thing for the European-only sample:

```{r}
library(nlme)
dep_vars = which(grepl('^Nresid', colnames(df_eur)))
indep_vars = which(grepl('^PROFILES', colnames(df_eur)))
res = as.data.frame(matrix(nrow=length(indep_vars), ncol=(2*length(dep_vars))))
rownames(res) = colnames(df_eur)[indep_vars]
i = 1
cnt = 1
while (i < 2*length(dep_vars)) {
  colnames(res)[i] = sprintf('%s_tstat', colnames(df_eur)[dep_vars][cnt])
  colnames(res)[i+1] = sprintf('%s_pval', colnames(df_eur)[dep_vars][cnt])
  i = i + 2
  cnt = cnt + 1
}
for (i in 1:length(indep_vars)) {
  for (j in 1:length(dep_vars)) {
    y_str = colnames(df_eur)[dep_vars][j]
    x_str = colnames(df_eur)[indep_vars][i]
    fm_str = sprintf('%s ~ %s', y_str, x_str)
    fit = try(lme(as.formula(fm_str), random=~1|FID, data=df_eur, na.action = na.omit))
    res[x_str, sprintf('%s_tstat', y_str)] = summary(fit)$tTable[x_str,'t-value']
    res[x_str, sprintf('%s_pval', y_str)] = summary(fit)$tTable[x_str,'p-value']
  }
}
```

```{r}
plot_me = which(grepl('_pval$', colnames(res)))
x = 1:nrow(res)
for (i in plot_me) {
  plot(x, res[, i], lty=3, ylab=colnames(res)[i], xlab='profiles')
}
write.csv(res, file='~/tmp/gwas_euroOnly_prs.csv')
```

It doesn't look like there's much there.

# GenR

Can we find anything in the GenR sample?

# Combined

Here's what we get using the combined sample:

